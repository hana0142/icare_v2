/** @license
 * (c) 2020 Shoreditch Ops Ltd. All rights reserved.
 *
 * This file is part of Artillery Pro (https://artillery.io)
 *
 * NOTICE: All information contained herein is, and remains
 * the property of Shoreditch Ops Ltd. The intellectual and
 * technical concepts contained herein are proprietary to
 * Shoreditch Ops Ltd and are protected by copyright law.
 *
 * Modification and/or redistribution of this material is
 * strictly forbidden unless prior written permission is
 * obtained from Shoreditch Ops Ltd.
 *
 */
"use strict";const os=require("os"),path=require("path"),fs=require("fs"),debug=require("debug")("artillery:pro"),jwt=require("jsonwebtoken"),AWS=require("aws-sdk"),chalk=require("chalk"),A=require("async"),supportedRegions=["us-east-1","us-east-2","us-west-1","us-west-2","ca-central-1","eu-west-1","eu-west-2","eu-west-3","eu-central-1","ap-south-1","ap-east-1","ap-northeast-2","ap-southeast-1","ap-southeast-2","ap-northeast-1","me-south-1"],partiallySupportedRegions=["cn-northwest-1","eu-west-3","eu-north-1","sa-east-1"],{S3_BUCKET_NAME_PREFIX}=require("./constants");function isActivated(callback){let data;if(process.env.ARTILLERY_PRO_TOKEN)data=process.env.ARTILLERY_PRO_TOKEN;else{var filePath=path.join(os.homedir(),".artillery","token");try{data=fs.readFileSync(filePath,"utf8"),data=data.replace("\n","")}catch(err){const e=new Error("Could not read token");return e.name="ActivationTokenError",callback(e,null)}}verify(data,function(err,decoded){if(err){const e=new Error("Could not verify activation token");return e.name="ActivationTokenError",callback(e,null)}return!decoded.it||decoded.sed>Date.now()?callback(null,decoded,data):callback(new Error(`This Artillery Pro trial license for ${decoded.email} has expired`),null)})}function vlk(token,callback){verify(token,(err,decoded)=>{if(err){const e=new Error("Could not verify license key");return e.name="LicenseKeyValidationError",callback(e,null)}if(decoded.it){if(decoded.sed>Date.now())return callback(null,decoded);{const e=new Error(`Artillery Pro trial license for ${decoded.email} has expired`);return e.name="LicenseKeyExpiredError",callback(e,null)}}return callback(null,decoded)})}function isActivatedSync(){let data=process.env.ARTILLERY_PRO_TOKEN;if(!data){var payload=path.join(os.homedir(),".artillery","token");try{data=fs.readFileSync(payload,"utf8")}catch(err){debug(err)}}if(!data)return!1;payload=verifySync(data);return!!payload&&(!payload.it||payload.sed>Date.now())}function ensureDotDir(callback){fs.mkdir(path.join(os.homedir(),".artillery"),function(){callback()})}const PUBLIC_KEY=`-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA+W5jx0a+iKORj7ikIlpm
MvHoL+9icjiQuyHfGYPNh4UsOnhAQhrnNGcK981I7UmI+wzKryLZu+R1rJiq8r51
Ya2f1CDwHZCXIN17+0dQEflyXl/NfAqxNaenP0GBnQ6bSFVbEflANpO9Jtn+GAz2
GutTv8taLHrPCxa1S0dbv/FestbYTDZkH4iIX7o5Z+hNtLkNKnzJesn0ZyUBpezg
YauGiPKQo6ESyzZIm7kBprH66Jiz0UcnI+w62i4aNj+wy9aegoIp0PvuAD2Q3M4y
U/k6XjxJcBj9QpxUNCqNCyaDUeagiL5Sbrk+1WkUwm54EXj8JkmixFz2elRWTNie
MwIDAQAB
-----END PUBLIC KEY-----
`;function verify(token,callback){jwt.verify(token,PUBLIC_KEY,{algorithms:["RS256"]},callback)}function verifySync(token){let payload=null;try{payload=jwt.verify(token,PUBLIC_KEY,{algorithms:["RS256"]})}catch(err){debug(err)}return payload||!1}async function getAccountId(cb){const sts=new AWS.STS;let accountId,err;try{accountId=(await sts.getCallerIdentity({}).promise()).Account}catch(stsErr){err=stsErr}if("function"!=typeof cb){if(err)throw err;return accountId}cb(err,accountId)}function atob(data){return Buffer.from(data,"base64").toString("ascii")}function btoa(data){return Buffer.from(data).toString("base64")}async function getBackendConfig(){var bucketName=await getBucketName();try{const s3Resp=await(new AWS.S3).getObject({Bucket:bucketName,Key:"artillerypro.rc"}).promise();return JSON.parse(Buffer.from(s3Resp.Body.toString(),"hex").toString())}catch(err){throw err}}function getRC(context,callback){let cb;cb="function"==typeof context&&void 0===callback?context:callback,getBucketName().then(bucketName=>{const s3=new AWS.S3;s3.getObject({Bucket:bucketName,Key:"artillerypro.rc"},(s3Err,s3Data)=>{if(s3Err)return cb(s3Err,null);{let metadataDoc;try{metadataDoc=JSON.parse(Buffer.from(s3Data.Body.toString(),"hex").toString())}catch(parseErr){debug(parseErr),debug(s3Data.Body),debug(Buffer.from(s3Data.Body,"hex"))}return metadataDoc?cb(null,metadataDoc):cb(new Error("Could not fetch RC object"),null)}})}).catch(err=>cb(err,null))}function putRC(doc,cb){getBucketName().then(bucketName=>{var body=Buffer.from(JSON.stringify(doc)).toString("hex");const s3=new AWS.S3;s3.putObject({Body:body,Bucket:bucketName,Key:"artillerypro.rc"},(s3Err,data)=>cb(s3Err||null))}).catch(err=>cb(err))}function updateRC(key,value,cb){getRC((getErr,doc)=>getErr?cb(getErr,null):(doc[key]=value,void putRC(doc,putErr=>putErr?cb(putErr,null):cb(null,doc))))}function getBucketName(){return new Promise((resolve,reject)=>{getAccountId((err,bucketName)=>{err?reject(err):(bucketName=`${S3_BUCKET_NAME_PREFIX}-${bucketName}`,resolve(bucketName,`arn:aws:s3:::${bucketName}`))})})}function formatError(err){return`${chalk.red("Error")}: ${err.message}`+(err.code?` (${err.code})`:"")}function listAllObjectsWithPrefix(bucket,prefix,cb){const s3=new AWS.S3;let result=[];let params={Bucket:bucket,MaxKeys:100,Prefix:prefix};A.doWhilst(function(next){s3.listObjectsV2(params,(s3Err,s3Data)=>s3Err?next(s3Err):(debug(`listObjectsV2: IsTruncated: ${s3Data.IsTruncated}`),debug(`listObjectsV2: KeyCount: ${s3Data.KeyCount} keys in the response`),result=result.concat(s3Data.Contents),s3Data.IsTruncated?(params.ContinuationToken=s3Data.NextContinuationToken,next(null,!0)):next(null,!1)))},function(shouldContinue){return shouldContinue},function(err){return err?cb(err):(debug(`listAllObjectsWithPrefix: returning ${result.length} results`),cb(null,result))})}function credentialsProvided(cb){var credsProvided=null!==(new AWS.Config).credentials;return cb?cb(credsProvided):credsProvided}module.exports={isActivated:isActivated,isActivatedSync:isActivatedSync,ensureDotDir:ensureDotDir,verify:verify,supportedRegions:supportedRegions,getAccountId:getAccountId,atob:atob,btoa:btoa,getRC:getRC,putRC:putRC,updateRC:updateRC,formatError:formatError,vlk:vlk,listAllObjectsWithPrefix:listAllObjectsWithPrefix,credentialsProvided:credentialsProvided,getBucketName:getBucketName,getBackendConfig:getBackendConfig};