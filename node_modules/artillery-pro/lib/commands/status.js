const A=require("async"),util=require("../util"),debug=require("debug")("commands:subscription"),moment=require("moment"),chalk=require("chalk"),AWS=require("aws-sdk"),ora=require("ora"),cloud=require("../artillery-cloud")(),{getAccountId}=require("../util"),{promisify}=require("util");async function status(options){if(options.email)await requestEmail(options);else{debug("credentials provided: ",null!==(new AWS.Config).credentials);const spinner=ora({spinner:"simpleDotsScrolling"});options.json||(console.log("========== Subscription status =========="),spinner.start());var accountId=await promisify(getAccountId)();let doc;try{doc=await promisify(util.getRC)(),spinner.stop()}catch(getErr){console.log(chalk.red("Subscription status could not be determined\n")),"CredentialsError"===getErr.code?(console.log("Error: AWS SDK could not load credentials\n"),console.log("Please make sure you are running Artillery with the appropriate AWS credentials configured"),console.log("See https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html for more information")):console.log(getErr),process.exit(1)}let decoded;try{decoded=await promisify(util.verify)(doc.token)}catch(verifyErr){console.log(verifyErr),process.exit(1)}try{if(await promisify(util.vlk)(doc.token),options.json){const result={awsAccountId:accountId,planName:decoded.planName,backendRegion:doc.backendRegion,backendVersion:doc.version,licenseEmail:decoded.email,maxWorkers:decoded.mw,maxParallelTestRuns:decoded.mcr};return decoded.it&&(result.isTrial=!0,result.expiresOn=decoded.sed),void console.log(JSON.stringify(result))}decoded.it?(console.log(`Artillery Pro trial license for ${decoded.email}`),console.log(`Expiry date: ${moment(decoded.sed).format("MMM D YYYY")}\n`),console.log("AWS account:",accountId),console.log(`Backend region: ${doc.backendRegion}`),console.log(`Limits:
  Parallel test runs: ${decoded.mcr||1}
  Workers per test run: ${decoded.mw||10}`),console.log("\nA license can be purchased on https://artillery.io/pro"),console.log(),console.log("Questions? Please get in touch via sales@artillery.io")):(console.log("AWS account:",accountId),console.log(`Subscription plan: ${decoded.planName}`),console.log(`Limits:
  Parallel test runs: ${decoded.mcr||1}
  Workers per test run: ${decoded.mw||10}`),console.log(`Backend region: ${doc.backendRegion}`),console.log(`Backend version: ${doc.version}`),console.log(`License email: ${decoded.email}`),console.log("\nManage your subscription via:\nhttps://artillery.chargebeeportal.com"),console.log(),console.log("Questions? Please get in touch via support@artillery.io"),debug(decoded))}catch(vlkErr){console.error("Something went wrong - could not verify license"),process.exit(1)}}}async function requestEmail(options){try{await cloud.requestLicenseKey({email:options.email})?console.log(chalk.green(`A license key is on its way to ${options.email} and should be with you shortly.`)):console.log(chalk.red(`
We could not find an active subscription for ${options.email}.
When requesting a license key, the email address that was used to subscribe
must be used.

Please see https://artillery.io/pro for subscription options for your team.

Drop us a line on team@artillery.io if you have any questions.`))}catch(err){console.log(chalk.red(`There was a problem requesting a license key for ${options.email}`)),debug(err),console.log(chalk.green("Please try again or drop us a line on team@artillery.io"))}}module.exports={status:status};