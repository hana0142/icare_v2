/** @license
 * (c) 2021 Shoreditch Ops Ltd. All rights reserved.
 *
 * This file is part of Artillery Pro (https://artillery.io)
 *
 * NOTICE: All information contained herein is, and remains
 * the property of Shoreditch Ops Ltd. The intellectual and
 * technical concepts contained herein are proprietary to
 * Shoreditch Ops Ltd and are protected by copyright law.
 *
 * Modification and/or redistribution of this material is
 * strictly forbidden unless prior written permission is
 * obtained from Shoreditch Ops Ltd.
 *
 */

module.exports = { getTests };

const AWS = require('aws-sdk');

const debug = require('debug')('commands:get-tests');

const { listAllObjectsWithPrefix, getBucketName } = require('../util');
const { ObjectStore } = require('../cloud/object-store');
const { promisify } = require('util');

const Store = require('../data-api/store')(process.env.BACKEND_STORE);

const Table = require('cli-table3');

async function getTests(options) {
  await Store.init();
  const runningTests = await Store.getRunningTests();
  debug(runningTests);

  let output = '';

  if(options.json) {
    output = JSON.stringify({tests: Object.keys(runningTests).map(k => runningTests[k])});
  }

  if(!options.json) {
    const t = new Table({ head: [ 'test id', 'region', 'cluster', 'launch type', 'workers', 'started at', 'last status' ]});

    for(const [id, r] of Object.entries(runningTests)) {
      t.push([
        r.testId,
        r.region,
        r.cluster,
        r.launchType,
        r.count,
        new Date(r.startedAt).toLocaleString(),
        r.lastStatus,
      ]);
    }

    output = t.toString();
  }


  if (Object.keys(runningTests).length === 0 && !options.json) {
    console.log('no running tests');
  } else {
    console.log(output);
  }
}
